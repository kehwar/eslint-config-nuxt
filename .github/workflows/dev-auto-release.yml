name: Merge Dev to Main

on:
  schedule:
    - cron: '0 0 * * 0' # This line schedules the job to run at 00:00 UTC every Sunday
  workflow_dispatch: # This line allows you to manually trigger this action from the GitHub Actions UI

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
    - name: 🛒 Checkout code
      uses: actions/checkout@v2
      with:
        ref: 'dev' # The branch you want to merge from

    - name: 😐 Configure Git
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'

    - name: 🟢 Merge to Main
      run: |
        git fetch --unshallow
        git checkout main
        git merge dev --no-commit
        HAS_CHANGES=$?
        git commit -m "Merge dev into main"
        echo "HAS_CHANGES=$HAS_CHANGES" >> $GITHUB_ENV
        git push

    - id: check_changes
      run: echo "::set-output name=has_changes::$HAS_CHANGES"

  release:
    runs-on: ubuntu-latest
    if: needs.merge.outputs.has_changes == '0'
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v2
      - name: 🖥️ Setup Node.js environment
        uses: actions/setup-node@v2.5.2
      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v2.2.4
        with:
          version: latest
          run_install: true
      - name: 😐 Set Git config
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
      - name: 🔑 Set NPM config
        run: pnpm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
        env:
          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
      - name: 🚀 Release
        run: pnpm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}